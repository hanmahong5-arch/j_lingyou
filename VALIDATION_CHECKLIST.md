# 服务器合规性系统验证清单

**创建日期**: 2025-12-29
**验证对象**: 服务器合规性三层验证系统

---

## 🎯 验证前准备

### 1. 编译项目

```bash
# 使用run.bat或手动编译
mvn clean compile

# 预期结果：BUILD SUCCESS
```

**检查点**:
- [ ] 编译成功，无错误
- [ ] 所有新增类都已编译
- [ ] 没有缺失的导入

### 2. 启动应用

```bash
# 运行应用
mvn javafx:run

# 或使用启动脚本
run.bat
```

**检查点**:
- [ ] 应用正常启动
- [ ] 数据库连接成功
- [ ] 主界面正常显示

---

## ✅ 核心验证（必做）

### 验证1：导出前预验证

**步骤**:
1. 打开"Aion机制浏览器"
2. 右键点击任一机制（推荐：物品系统）
3. 选择"批量导出 (DB → XML)"
4. 观察对话框前几行日志

**预期结果**:
```
开始批量导出数据...
正在进行导出前检查...
预检查完成: X个可导出, Y个有警告
```

**验证清单**:
- [ ] 看到"正在进行导出前检查..."消息
- [ ] 看到"预检查完成"消息
- [ ] 如果有黑名单字段，会显示将被过滤的数量

**如果失败**: 参见 `docs/QUICK_VALIDATION_GUIDE.md` 的故障排查部分

---

### 验证2：导出时字段过滤

**步骤**:
1. 继续上一步的导出，等待完成
2. 找到导出的XML文件（在原始XML文件位置）
3. 用文本编辑器打开
4. 搜索以下黑名单字段：
   - `__order_index`
   - `status_fx_slot_lv`
   - `toggle_id`

**预期结果**:
- ❌ 搜索不到任何黑名单字段
- ✅ 文件包含正常字段（id, name, level等）

**验证清单**:
- [ ] XML文件存在且大小>0
- [ ] 不包含`__order_index`字段
- [ ] 不包含`status_fx_slot_lv`字段（skill_base表）
- [ ] 不包含`toggle_id`字段（skill_base表）
- [ ] 包含正常字段（id, name等）

**如果失败**: 检查ServerComplianceFilter是否被正确调用

---

### 验证3：导出后合规性检查

**步骤**:
1. 继续观察批量导出对话框
2. 等待所有文件导出完成
3. 观察最后几行日志

**预期结果**:
```
正在进行服务器合规性检查...
✅ 合规性检查通过: X 个文件全部符合服务器要求

批量导出完成
```

**验证清单**:
- [ ] 看到"正在进行服务器合规性检查..."消息
- [ ] 看到合规性检查结果
- [ ] 如果全部合规，显示绿色✅消息
- [ ] 如果有不合规，列出具体文件和字段

**如果失败**: 检查XmlServerComplianceChecker类是否编译成功

---

### 验证4：命令行工具

**步骤**:
1. 打开命令行终端
2. 切换到项目目录
3. 运行以下命令：

```bash
# Windows（示例：检查items.xml）
java -cp "target\classes;target\dependency\*" red.jiuzhou.validation.server.XmlComplianceCheckCLI "src\main\resources\CONF\D\AionReal58\AionMap\XML\China\allNodeXml\items.xml"

# Linux/Mac
java -cp "target/classes:target/dependency/*" red.jiuzhou.validation.server.XmlComplianceCheckCLI "src/main/resources/CONF/D/AionReal58/AionMap/XML/China/allNodeXml/items.xml"
```

**预期结果**:
```
================================================================================
XML服务器合规性检查工具
================================================================================

检查文件: items.xml

================================================================================
文件: items.xml
表名: items
服务器兼容性: ✅ 合规
记录数: XX,XXX
================================================================================

✅ 该文件符合服务器加载要求，可以安全部署。
```

**验证清单**:
- [ ] 命令执行成功（退出码0）
- [ ] 显示文件基本信息
- [ ] 显示合规性状态
- [ ] 如果合规，显示✅
- [ ] 如果不合规，列出黑名单字段

**如果失败**: 检查Java classpath和文件路径

---

## 🔬 高级验证（可选）

### 验证5：主UI批量导出

**步骤**:
1. 在主界面左侧目录树中选择一个包含多个XML文件的目录
2. 右键点击，选择"一键导出XML"
3. 观察是否有预验证确认对话框

**预期结果**:
- 弹出预检查结果对话框
- 显示可导出数量、警告数量、将过滤的字段数量
- 询问是否继续

**验证清单**:
- [ ] 看到预检查对话框
- [ ] 对话框显示统计信息
- [ ] 可以选择继续或取消
- [ ] 导出过程正常

---

### 验证6：黑名单字段检测

**创建测试文件**:
```xml
<!-- test_blacklist.xml -->
<?xml version="1.0" encoding="UTF-8"?>
<items>
    <item id="1" name="Test Item" __order_index="1" status_fx_slot_lv="5" toggle_id="10">
    </item>
</items>
```

**运行检查**:
```bash
java -cp "target/classes:target/dependency/*" red.jiuzhou.validation.server.XmlComplianceCheckCLI test_blacklist.xml
```

**预期结果**:
```
❌ 发现黑名单字段 (3个):
  • __order_index - 会导致服务器"undefined token"错误
  • status_fx_slot_lv - 会导致服务器"undefined token"错误
  • toggle_id - 会导致服务器"undefined token"错误

⚠️  警告: 该文件不符合服务器加载要求！
```

**验证清单**:
- [ ] 正确检测出3个黑名单字段
- [ ] 每个字段都有错误描述
- [ ] 退出码为1（表示不合规）

---

### 验证7：批量导出所有系统

**步骤**:
1. 在机制浏览器中，依次选择各个游戏系统
2. 对每个系统执行批量导出
3. 记录导出结果

**建议测试的系统**:
- [ ] 物品系统（ITEM）
- [ ] 技能系统（SKILL）
- [ ] NPC系统（NPC）
- [ ] 任务系统（QUEST）
- [ ] 宠物系统（PET）
- [ ] 深渊系统（ABYSS）
- [ ] PVP系统（PVP）

**记录内容**:
- 每个系统的文件数
- 导出成功数
- 导出失败数
- 合规性检查结果
- 发现的问题

---

### 验证8：实际服务器部署（终极验证）

**警告**: 仅在测试服务器上执行！

**步骤**:
1. 导出一个完整的游戏系统（如：物品系统）
2. 备份测试服务器的原始XML文件
3. 将导出的XML文件复制到测试服务器
4. 启动测试服务器
5. 检查服务器日志

**预期结果**:
- ✅ 服务器正常启动
- ✅ 无"undefined token"错误
- ✅ 无XML解析错误
- ✅ 数据正常加载

**验证清单**:
- [ ] 服务器启动成功
- [ ] MainServer日志无错误
- [ ] NPCServer日志无错误
- [ ] 游戏功能正常
- [ ] 数据加载正确

**如果失败**:
1. 检查服务器日志，记录具体错误
2. 识别问题字段
3. 在XmlFileValidationRules中添加该字段到黑名单
4. 重新导出并测试

---

## 📊 验证结果汇总

### 基础验证结果

| 验证项 | 状态 | 备注 |
|-------|------|------|
| 导出前预验证 | ⬜ 通过 / ⬜ 失败 | |
| 导出时字段过滤 | ⬜ 通过 / ⬜ 失败 | |
| 导出后合规性检查 | ⬜ 通过 / ⬜ 失败 | |
| 命令行工具 | ⬜ 通过 / ⬜ 失败 | |

### 高级验证结果

| 验证项 | 状态 | 备注 |
|-------|------|------|
| 主UI批量导出 | ⬜ 通过 / ⬜ 失败 | |
| 黑名单字段检测 | ⬜ 通过 / ⬜ 失败 | |
| 批量导出所有系统 | ⬜ 通过 / ⬜ 失败 | |
| 实际服务器部署 | ⬜ 通过 / ⬜ 失败 | |

### 发现的问题

1. _______________________________________________
2. _______________________________________________
3. _______________________________________________

### 需要改进的地方

1. _______________________________________________
2. _______________________________________________
3. _______________________________________________

---

## 🎓 验证建议

### 优先级排序

**P0（必须验证）**:
1. 导出前预验证
2. 导出时字段过滤
3. 导出后合规性检查

**P1（强烈建议）**:
4. 命令行工具
5. 批量导出所有系统

**P2（可选）**:
6. 主UI批量导出
7. 黑名单字段检测
8. 实际服务器部署

### 验证顺序

建议按照以下顺序进行验证，逐步提高复杂度：

```
1. 编译项目 → 2. 启动应用 → 3. 验证1-3（基础功能）
    ↓
4. 验证4（命令行工具）
    ↓
5. 验证5-7（高级功能）
    ↓
6. 验证8（实际部署） - 最后一步
```

---

## 📝 验证报告模板

```
【服务器合规性系统验证报告】

验证日期：____________________
验证人员：____________________
项目版本：____________________

【编译结果】
□ 编译成功
□ 编译失败（原因：________________）

【基础验证】
□ 导出前预验证 - 通过/失败
□ 导出时字段过滤 - 通过/失败
□ 导出后合规性检查 - 通过/失败
□ 命令行工具 - 通过/失败

【高级验证】
□ 主UI批量导出 - 通过/失败
□ 黑名单字段检测 - 通过/失败
□ 批量导出所有系统 - 通过/失败
□ 实际服务器部署 - 通过/失败

【发现的问题】
1. _____________________________
2. _____________________________
3. _____________________________

【建议的改进】
1. _____________________________
2. _____________________________
3. _____________________________

【总体评价】
□ 系统完全正常，可以投入使用
□ 基本正常，有小问题需要修复
□ 存在严重问题，需要重大修复

【下一步行动】
1. _____________________________
2. _____________________________

验证人签名：____________________
审核人签名：____________________
```

---

## 🆘 故障排查快速参考

### 问题1：编译失败

**解决方法**:
```bash
# 清理并重新编译
mvn clean
mvn compile

# 检查是否有缺失的依赖
mvn dependency:tree
```

### 问题2：预验证不显示

**检查**:
- PreExportValidator类是否编译
- UI集成代码是否存在
- 日志级别是否正确

### 问题3：黑名单字段未过滤

**检查**:
- ServerComplianceFilter是否被调用
- XmlFileValidationRules是否包含该表
- 字段名是否完全匹配

### 问题4：合规性检查不执行

**检查**:
- XmlServerComplianceChecker类是否编译
- 导出是否正常完成
- 日志中是否有异常

### 问题5：命令行工具报错

**检查**:
- classpath是否正确
- 文件路径是否存在
- Java版本是否正确（需要Java 21+）

---

## 📚 参考文档

- **快速验证指南**: `docs/QUICK_VALIDATION_GUIDE.md`
- **实施总结**: `docs/SERVER_COMPLIANCE_IMPLEMENTATION_2025-12-29.md`
- **设计师指南**: `docs/DESIGNER_QUICK_START_GUIDE.md`
- **会话总结**: `docs/SESSION_SUMMARY_2025-12-29.md`

---

## ✅ 验证完成标准

满足以下条件即可认为验证通过：

**必要条件**（全部满足）:
- [x] 编译成功，无错误
- [x] 导出前预验证正常显示
- [x] 导出的XML不包含黑名单字段
- [x] 导出后合规性检查通过

**充分条件**（至少满足3个）:
- [ ] 命令行工具正常工作
- [ ] 主UI批量导出有预验证
- [ ] 批量导出至少3个系统成功
- [ ] 实际服务器部署无错误

---

**验证清单结束**

祝验证顺利！如有问题，请查阅参考文档或联系开发团队。
