# 游戏机制分类UI集成说明

## 概述

**实现日期**: 2025-12-21
**版本**: v2.0 UI集成版

将YAML配置文件的功能完全集成到图形界面，设计师无需手动编辑YAML文件，通过统一的UI界面即可完成所有机制分类管理工作。

## 核心功能

### 1. 机制分类管理器（主对话框）

**位置**：机制浏览器 → 工具栏 → "⚙️ 管理分类"按钮

**功能**：
- ✅ 查看所有手动覆盖配置
- ✅ 查看所有排除文件列表
- ✅ 添加/编辑/删除手动覆盖
- ✅ 添加/删除排除文件
- ✅ 保存配置到YAML文件
- ✅ 实时统计显示

**界面布局**：
```
┌─────────────────────────────────────────────────────────┐
│ 🎮 游戏机制分类管理                                      │
│ 管理XML文件的机制分类配置，修改后需要重启应用生效         │
│ 📊 当前配置: 5 个手动覆盖, 2 个排除文件                   │
├─────────────────────────────────────────────────────────┤
│ [手动覆盖配置]  [排除文件列表]                           │
│                                                          │
│ 💡 手动覆盖的优先级最高，会覆盖自动检测结果              │
│                                                          │
│ [➕ 添加覆盖]  [🔄 刷新]                                  │
│                                                          │
│ ┌───────────────────────────────────────────────────┐   │
│ │ 文件名            │ 机制分类  │ 操作              │   │
│ ├───────────────────────────────────────────────────┤   │
│ │ custom_skill.xml  │ 技能系统  │ [修改] [删除]    │   │
│ │ my_item.xml       │ 物品系统  │ [修改] [删除]    │   │
│ └───────────────────────────────────────────────────┘   │
│                                                          │
├─────────────────────────────────────────────────────────┤
│                                    [💾 保存配置] [关闭]  │
└─────────────────────────────────────────────────────────┘
```

### 2. 文件右键菜单（机制浏览器）

**位置**：机制浏览器 → 文件列表 → 右键点击文件

**新增菜单项**：
- 🎮 **修改机制分类...** - 快速修改文件的机制归属
- 🚫 **从机制中排除** - 将文件标记为 OTHER，不属于任何机制
- 🔄 **重置为自动检测** - 删除手动覆盖，恢复自动检测
- ⚙️ **管理所有机制分类...** - 打开管理器对话框

**完整右键菜单**：
```
📄 打开（查看字段）
📁 在资源管理器中显示
🔗 使用外部程序打开
──────────────────
📋 复制完整路径
📝 复制相对路径
📝 复制文件名
──────────────────
ℹ️ 文件信息
📤 导出文件内容
──────────────────
🎮 修改机制分类...     ← 新增
🚫 从机制中排除         ← 新增
🔄 重置为自动检测       ← 新增
──────────────────
⚙️ 管理所有机制分类... ← 新增
```

### 3. 工具栏按钮

**位置**：机制浏览器 → 顶部工具栏

**新增按钮**：
- **⚙️ 管理分类** - 绿色按钮，快速打开管理器

**工具栏布局**：
```
Aion 机制浏览器  [← 返回]  [刷新]  [⚙️ 管理分类]
```

## 使用场景

### 场景1：快速修改单个文件的分类

**问题**：`my_custom_skill.xml` 被错误分类为 `OTHER`，应该是 `SKILL`

**解决步骤**：
1. 在机制浏览器中找到该文件
2. 右键点击文件
3. 选择 "🎮 修改机制分类..."
4. 从下拉菜单选择 "技能系统"
5. 点击 OK
6. 系统自动保存配置
7. 重启应用生效

**效果**：
- ✅ 配置自动保存到 `mechanism_manual_overrides.yml`
- ✅ 弹出确认对话框，提示重启应用
- ✅ 状态栏显示操作结果

### 场景2：批量管理多个文件

**问题**：需要同时调整10个文件的分类

**解决步骤**：
1. 点击工具栏 "⚙️ 管理分类" 按钮
2. 在管理器中点击 "➕ 添加覆盖"
3. 输入文件名，选择机制分类
4. 重复添加所有文件
5. 点击 "💾 保存配置"
6. 重启应用

**效果**：
- ✅ 统一管理所有手动覆盖
- ✅ 可以批量查看、修改、删除
- ✅ 实时显示统计信息

### 场景3：排除临时文件

**问题**：`test_data.xml` 是测试文件，不应该出现在任何机制中

**解决步骤**：
1. 右键点击该文件
2. 选择 "🚫 从机制中排除"
3. 确认排除操作
4. 系统自动保存
5. 重启应用

**效果**：
- ✅ 文件被添加到排除列表
- ✅ 下次扫描时会被标记为 OTHER

### 场景4：恢复自动检测

**问题**：之前手动覆盖了某个文件，现在想恢复自动检测

**解决步骤**：
1. 右键点击该文件
2. 选择 "🔄 重置为自动检测"
3. 系统检查并显示当前配置
4. 确认重置
5. 自动删除手动覆盖/排除配置
6. 重启应用

**效果**：
- ✅ 删除手动配置
- ✅ 恢复使用自动检测逻辑

## 技术实现

### 核心类

| 类名 | 职责 | 文件路径 |
|------|------|----------|
| `MechanismOverrideEditorDialog` | 机制分类管理器对话框 | `red.jiuzhou.ui.MechanismOverrideEditorDialog` |
| `MechanismOverrideConfig` | 配置加载器和保存器 | `red.jiuzhou.analysis.aion.MechanismOverrideConfig` |
| `AionMechanismExplorerStage` | 机制浏览器（集成右键菜单和工具栏）| `red.jiuzhou.ui.AionMechanismExplorerStage` |

### 新增方法

#### MechanismOverrideConfig.java

```java
// 添加手动覆盖
public synchronized void addOverride(String fileName, AionMechanismCategory category)

// 删除手动覆盖
public synchronized void removeOverride(String fileName)

// 添加排除文件
public synchronized void addExcluded(String fileName)

// 删除排除文件
public synchronized void removeExcluded(String fileName)

// 保存配置到YAML文件
public synchronized void save()

// 获取所有手动覆盖（用于UI显示）
public Map<String, AionMechanismCategory> getAllOverrides()
```

#### AionMechanismExplorerStage.java

```java
// 修改文件的机制分类
private void changeMechanismClassification(AionMechanismView.FileEntry fileEntry)

// 将文件从机制中排除
private void excludeFile(AionMechanismView.FileEntry fileEntry)

// 重置为自动检测
private void resetToAutoDetection(AionMechanismView.FileEntry fileEntry)

// 打开机制分类管理器
private void openMechanismManager()
```

### 数据流

```
用户操作（右键菜单/按钮）
    ↓
对话框（获取用户输入）
    ↓
MechanismOverrideConfig（修改内存中的配置）
    ↓
config.save()（保存到YAML文件）
    ↓
提示用户重启应用
    ↓
重启后，config.load()（重新加载配置）
    ↓
AionMechanismDetector.detect()（使用新配置检测）
```

### 配置文件格式

保存的YAML文件格式：

```yaml
# 游戏机制手动覆盖配置
# 此文件由UI界面自动生成，也可以手动编辑
# 修改后重启应用即可生效

manual_overrides:
  SKILL:
  - custom_skill.xml
  - my_skill.xml
  ITEM:
  - custom_item.xml
excluded_files:
- test_data.xml
- backup_file.xml
```

## UI设计规范

### 颜色方案

| 元素 | 颜色 | 说明 |
|------|------|------|
| 主按钮 | #2ea44f（绿色）| 保存、确认操作 |
| 次按钮 | #3498db（蓝色）| 刷新、一般操作 |
| 返回按钮 | #95a5a6（灰色）| 取消、返回操作 |
| 信息提示 | #ddf4ff（浅蓝）| INFO级别提示 |
| 警告提示 | #fff8c5（浅黄）| WARNING级别提示 |

### 图标使用

| 操作 | 图标 | 含义 |
|------|------|------|
| 管理分类 | ⚙️ | 设置/配置 |
| 修改分类 | 🎮 | 游戏机制 |
| 排除文件 | 🚫 | 禁止/排除 |
| 重置检测 | 🔄 | 刷新/重置 |
| 添加覆盖 | ➕ | 新增 |
| 保存配置 | 💾 | 保存 |
| 统计信息 | 📊 | 数据统计 |

### 对话框标准

所有对话框遵循统一标准：

1. **确认对话框**：
   - 标题：清晰说明操作
   - 内容：显示详细信息和影响范围
   - 按钮：OK / Cancel

2. **信息对话框**：
   - 成功：绿色勾选图标 ✅
   - 失败：红色错误图标 ❌
   - 提示：蓝色信息图标 ℹ️
   - 警告：黄色警告图标 ⚠️

3. **输入对话框**：
   - 提供清晰的提示文本
   - 使用占位符说明格式
   - 自动聚焦到输入框

## 错误处理

### 保存失败

**场景**：配置文件无法写入（权限问题、磁盘满等）

**处理**：
```java
try {
    config.save();
} catch (Exception e) {
    Alert alert = new Alert(Alert.AlertType.ERROR);
    alert.setTitle("保存失败");
    alert.setHeaderText("保存配置时发生错误");
    alert.setContentText(e.getMessage());
    alert.showAndWait();
}
```

### 文件不存在

**场景**：手动输入的文件名在目录中不存在

**处理**：
- 允许添加（可能是未来会添加的文件）
- 在管理器中用不同颜色标记（可选功能）

### 重复配置

**场景**：同一个文件在多个机制中配置

**处理**：
- 使用第一个匹配项
- 输出警告日志
- UI中高亮显示冲突（可选功能）

## 用户体验优化

### 1. 即时反馈

- ✅ 每个操作都有确认对话框
- ✅ 操作成功后显示结果
- ✅ 状态栏实时更新操作信息

### 2. 智能提示

- ✅ 所有对话框包含详细说明
- ✅ 提示用户重启应用才能生效
- ✅ 显示当前配置状态

### 3. 批量操作支持

- ✅ 管理器支持批量添加/删除
- ✅ 表格显示所有配置，一目了然
- ✅ 支持搜索和过滤（可选功能）

### 4. 撤销机制

- ✅ 配置保存前可以取消
- ✅ 重置功能可以恢复自动检测
- ✅ YAML文件可以手动编辑回退

## 快捷键支持（规划中）

| 快捷键 | 功能 |
|--------|------|
| `Ctrl+M` | 打开机制分类管理器 |
| `Ctrl+Shift+M` | 修改当前选中文件的分类 |
| `Ctrl+E` | 排除当前选中文件 |
| `Ctrl+R` | 重置当前选中文件 |

## 性能考虑

### 1. 延迟加载

- 管理器对话框按需打开
- 配置文件只在启动时加载一次

### 2. 内存优化

- 使用 `ObservableList` 而不是频繁重建列表
- 表格单元格复用

### 3. 线程安全

- 所有配置修改操作使用 `synchronized`
- UI操作在 JavaFX 线程执行

## 测试建议

### 功能测试

- [ ] 打开机制分类管理器
- [ ] 添加手动覆盖配置
- [ ] 修改现有覆盖配置
- [ ] 删除覆盖配置
- [ ] 添加排除文件
- [ ] 删除排除文件
- [ ] 保存配置到YAML
- [ ] 验证YAML文件格式正确
- [ ] 重启应用后配置生效
- [ ] 右键菜单所有选项可用
- [ ] 工具栏按钮可点击

### 边界测试

- [ ] 空配置文件
- [ ] 大量覆盖配置（1000+条）
- [ ] 特殊字符文件名
- [ ] 中文文件名
- [ ] 超长文件名
- [ ] 重复文件名

### 错误测试

- [ ] 配置文件权限只读
- [ ] 磁盘空间不足
- [ ] 文件被其他程序占用
- [ ] YAML格式错误
- [ ] 不存在的机制分类

## 后续改进方向

### 计划中的功能

1. **批量导入导出**
   - 从CSV导入批量配置
   - 导出配置为Excel文件

2. **配置模板**
   - 预设常见配置模板
   - 一键应用模板

3. **配置对比**
   - 显示手动配置与自动检测的差异
   - 高亮显示被覆盖的文件

4. **搜索和过滤**
   - 在管理器中搜索文件名
   - 按机制分类过滤

5. **配置验证**
   - 检测配置冲突
   - 提示无效的文件名
   - 验证文件是否存在

6. **操作历史**
   - 记录所有配置修改历史
   - 支持撤销/重做

### 扩展到其他界面

- 左侧目录树的右键菜单
- 数据页签的右键菜单
- 批量操作对话框集成

## 常见问题

### Q1: 修改后为什么没有立即生效？

**A**: 配置修改需要重启应用才能生效。系统会在保存后提示重启。

**原因**: 机制检测在应用启动时执行，运行时不会重新检测。

### Q2: 可以同时手动编辑YAML文件和使用UI吗？

**A**: 可以。UI生成的YAML文件格式标准，可以手动编辑。但建议只用一种方式，避免混淆。

**注意**: 如果手动编辑后UI再次保存，手动添加的注释会丢失。

### Q3: 配置文件保存在哪里？

**A**: 保存在 `target/classes/mechanism_manual_overrides.yml`（编译后的资源目录）

**源文件**: `src/main/resources/mechanism_manual_overrides.yml`

### Q4: 如何备份配置？

**A**: 直接复制 `mechanism_manual_overrides.yml` 文件即可。

**恢复**: 将备份文件覆盖回原位置，重启应用。

### Q5: 删除所有配置会怎样？

**A**: 系统会恢复使用完全自动检测，所有文件按照原有逻辑分类。

## 相关文档

- `docs/MECHANISM_DYNAMIC_CLASSIFICATION.md` - 混合配置系统说明
- `docs/MECHANISM_EXPLORER_GUIDE.md` - 机制浏览器使用指南
- `src/main/resources/mechanism_manual_overrides.yml` - 配置文件模板

## 贡献者

- Claude Sonnet 4.5 (AI Assistant) - UI集成设计与实现

## 更新日志

| 日期 | 版本 | 说明 |
|------|------|------|
| 2025-12-21 | v2.0 | 完整UI集成，包含管理器对话框、右键菜单、工具栏按钮 |

---

**实现完成** ✅ - UI完全集成，设计师可以通过图形界面轻松管理机制分类。
