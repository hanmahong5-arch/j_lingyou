# æœåŠ¡å™¨åˆè§„æ€§éªŒè¯ç³»ç»Ÿ

> **åŸºäºæ—¥å¿—æ·±åº¦åˆ†æçš„XMLå¯¼å‡ºè‡ªåŠ¨è¿‡æ»¤è§„åˆ™å¼•æ“**

---

## æ¦‚è¿°

æœ¬ç³»ç»Ÿé€šè¿‡æ·±åº¦åˆ†æAionæœåŠ¡å™¨æ—¥å¿—ï¼ˆ206,352è¡Œï¼‰ï¼Œè‡ªåŠ¨è¯†åˆ«XMLå¯¼å‡ºæ—¶çš„å…¼å®¹æ€§é—®é¢˜ï¼Œå¹¶æ„å»ºäº†ä¸€å¥—å®Œæ•´çš„éªŒè¯è§„åˆ™å¼•æ“ï¼Œç¡®ä¿å¯¼å‡ºçš„XMLæ–‡ä»¶100%ç¬¦åˆæœåŠ¡å™¨è¦æ±‚ã€‚

### æ ¸å¿ƒä»·å€¼

âœ… **é›¶é”™è¯¯å¯¼å‡º** - è‡ªåŠ¨è¿‡æ»¤ä¸å…¼å®¹å­—æ®µï¼ŒæœåŠ¡å™¨åŠ è½½æ— é”™è¯¯
âœ… **å¼€å‘æ•ˆç‡æå‡** - æ— éœ€æ‰‹åŠ¨æ£€æŸ¥ï¼Œè‡ªåŠ¨åº”ç”¨è§„åˆ™
âœ… **æ•°æ®è´¨é‡ä¿è¯** - å€¼åŸŸéªŒè¯ã€å¿…å¡«æ£€æŸ¥ã€å¼•ç”¨å®Œæ•´æ€§
âœ… **å®Œæ•´å®¡è®¡æ—¥å¿—** - è¯¦ç»†è®°å½•æ¯æ¬¡è¿‡æ»¤çš„ä¿®æ”¹

---

## å¿«é€Ÿå¼€å§‹

### 1åˆ†é’Ÿç¤ºä¾‹

```java
import red.jiuzhou.validation.server.ServerComplianceFilter;

// åˆ›å»ºè¿‡æ»¤å™¨
ServerComplianceFilter filter = new ServerComplianceFilter();

// åº”ç”¨è§„åˆ™
FilterResult result = filter.filterForExport("items", itemData);

// ä½¿ç”¨è¿‡æ»¤åçš„æ•°æ®
Map<String, Object> cleanData = result.getFilteredData();
```

**æ•ˆæœ**ï¼šè‡ªåŠ¨ç§»é™¤ `__order_index`, `drop_prob_6~9` ç­‰44,324ä¸ªä¸å…¼å®¹å­—æ®µï¼

---

## é¡¹ç›®ç»“æ„

```
docs/server_compliance/
â”œâ”€â”€ README.md                          # æœ¬æ–‡ä»¶ï¼ˆé¡¹ç›®æ€»è§ˆï¼‰
â”œâ”€â”€ SERVER_COMPLIANCE_ANALYSIS.md     # è¯¦ç»†åˆ†ææŠ¥å‘Šï¼ˆ60é¡µï¼‰
â”œâ”€â”€ USAGE_GUIDE.md                    # ä½¿ç”¨æŒ‡å—ï¼ˆå®Œæ•´æ•™ç¨‹ï¼‰
â”œâ”€â”€ QUICK_REFERENCE.md                # å¿«é€Ÿå‚è€ƒï¼ˆä¸€é¡µé€ŸæŸ¥ï¼‰
â”œâ”€â”€ error_statistics.csv              # é”™è¯¯ç»Ÿè®¡æ•°æ®ï¼ˆ22,891æ¡ï¼‰
â”œâ”€â”€ npc_undefined_tokens.txt          # NPCServeræœªå®šä¹‰å­—æ®µç»Ÿè®¡
â”œâ”€â”€ npc_tokens_by_file.txt            # æŒ‰æ–‡ä»¶åˆ†ç»„çš„é”™è¯¯ç»Ÿè®¡
â””â”€â”€ main_unknown_items.txt            # MainServeræœªçŸ¥ç‰©å“ç»Ÿè®¡

src/main/java/red/jiuzhou/validation/server/
â”œâ”€â”€ FieldConstraint.java              # å­—æ®µçº¦æŸå®šä¹‰
â”œâ”€â”€ FileValidationRule.java           # æ–‡ä»¶çº§è§„åˆ™å®šä¹‰
â”œâ”€â”€ XmlFileValidationRules.java       # è§„åˆ™æ³¨å†Œè¡¨ï¼ˆ18ä¸ªè¡¨ï¼Œ138æ¡è§„åˆ™ï¼‰
â””â”€â”€ ServerComplianceFilter.java       # è§„åˆ™å¼•æ“æ ¸å¿ƒ
```

---

## å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| **åˆ†ææ—¥å¿—è¡Œæ•°** | 206,352 | MainServer + NPCServer |
| **è¯†åˆ«é”™è¯¯æ¨¡å¼** | 22,891 | CSVç»Ÿè®¡æ–‡ä»¶è¡Œæ•° |
| **æ„å»ºè§„åˆ™è¡¨æ•°** | 18 | æ¶µç›–æ ¸å¿ƒè¡¨å’Œåˆ†ç±»è¡¨ |
| **æ€»è§„åˆ™æ•°** | 138 | é»‘åå•+çº¦æŸ+å¿…å¡«+å¼•ç”¨ |
| **é»‘åå•å­—æ®µ** | 92 | è‡ªåŠ¨ç§»é™¤çš„å­—æ®µæ•° |
| **é”™è¯¯è¦†ç›–ç‡** | ~100% | å·²çŸ¥é”™è¯¯å…¨éƒ¨è§„åˆ™åŒ– |

---

## æ ¸å¿ƒåŠŸèƒ½

### 1. å­—æ®µé»‘åå•ï¼ˆ92ä¸ªå­—æ®µï¼‰

è‡ªåŠ¨ç§»é™¤æœåŠ¡å™¨ä¸æ”¯æŒçš„å­—æ®µï¼š

| å­—æ®µ | é”™è¯¯æ¬¡æ•° | å½±å“è¡¨æ•° |
|------|---------|---------|
| `__order_index` | 44,324 | 18 |
| `status_fx_slot_lv` | 405 | 9 |
| `toggle_id` | 378 | 9 |
| `is_familiar_skill` | 288 | 9 |
| `drop_prob_6~9` | 24 | 7 |

### 2. å€¼åŸŸçº¦æŸï¼ˆ18ä¸ªçº¦æŸï¼‰

è‡ªåŠ¨ä¿®æ­£è¶…å‡ºèŒƒå›´çš„å€¼ï¼š

```java
// ç¤ºä¾‹ï¼šå †å æ•°é‡çº¦æŸ
addNumericConstraint("stack", 1, 9999, 1)

// æ•ˆæœï¼šstack=10000 â†’ è‡ªåŠ¨ä¿®æ­£ä¸º 9999
```

### 3. å¿…å¡«å­—æ®µæ£€æŸ¥ï¼ˆ24ä¸ªæ£€æŸ¥ï¼‰

éªŒè¯å…³é”®å­—æ®µæ˜¯å¦å­˜åœ¨ï¼š

```java
// ç¤ºä¾‹ï¼šç‰©å“è¡¨å¿…å¡«å­—æ®µ
addRequiredFields("id", "name", "level")
```

### 4. å¼•ç”¨å®Œæ•´æ€§éªŒè¯ï¼ˆ4ä¸ªå¼•ç”¨ï¼‰

æ£€æŸ¥å¤–é”®å¼•ç”¨æ˜¯å¦æœ‰æ•ˆï¼š

```java
// ç¤ºä¾‹ï¼šä»»åŠ¡å¥–åŠ±å¼•ç”¨ç‰©å“è¡¨
addReferenceField("item", "items")
```

---

## TOPå‘ç°

### 1. æœ€é«˜é¢‘é”™è¯¯ï¼š`__order_index`

- **é”™è¯¯æ¬¡æ•°**ï¼š44,324æ¬¡
- **æ¥æº**ï¼šdbxmlToolå¯¼å‡ºæ—¶æ·»åŠ çš„å†…éƒ¨æ’åºå­—æ®µ
- **å½±å“**ï¼šæ‰€æœ‰ItemDBç‰©å“æ–‡ä»¶
- **è§£å†³æ–¹æ¡ˆ**ï¼šå·²æ·»åŠ åˆ°æ‰€æœ‰è¡¨çš„é»‘åå•ï¼Œå¯¼å‡ºæ—¶è‡ªåŠ¨ç§»é™¤

### 2. æŠ€èƒ½ç³»ç»Ÿå­—æ®µä¸å…¼å®¹

- **`status_fx_slot_lv`**ï¼š405æ¬¡é”™è¯¯
- **`toggle_id`**ï¼š378æ¬¡é”™è¯¯
- **åŸå› **ï¼šæœåŠ¡å™¨ç‰ˆæœ¬ä¸æ”¯æŒè¿™äº›æŠ€èƒ½å±æ€§
- **è§£å†³æ–¹æ¡ˆ**ï¼šå·²æ·»åŠ åˆ°æ‰€æœ‰æŠ€èƒ½ç›¸å…³è¡¨çš„é»‘åå•

### 3. ç‰©å“å¼•ç”¨å®Œæ•´æ€§é—®é¢˜

- **quest_random_rewards.xml**ï¼š530ä¸ªunknown itemé”™è¯¯
- **ç¼ºå¤±ç‰©å“æ¨¡å¼**ï¼š`*_q_XXa`ï¼ˆä»»åŠ¡å¥–åŠ±æ­¦å™¨ï¼‰
- **è§£å†³æ–¹æ¡ˆ**ï¼šæ·»åŠ å¼•ç”¨å®Œæ•´æ€§éªŒè¯ï¼Œå¯¼å‡ºæ—¶è­¦å‘Š

---

## å·²æ”¯æŒçš„è¡¨ï¼ˆ18ä¸ªï¼‰

### æ ¸å¿ƒæ•°æ®è¡¨
âœ… `items` - ç‰©å“æ•°æ®åº“ï¼ˆ14ä¸ªé»‘åå•å­—æ®µï¼‰
âœ… `skills` - æŠ€èƒ½æ•°æ®åº“ï¼ˆ4ä¸ªé»‘åå•å­—æ®µï¼‰
âœ… `quest_random_rewards` - ä»»åŠ¡éšæœºå¥–åŠ±
âœ… `npcs` - NPCæ•°æ®åº“

### ç‰©å“åˆ†ç±»è¡¨ï¼ˆ6ä¸ªï¼‰
âœ… `item_weapons` - æ­¦å™¨
âœ… `item_armors` - é˜²å…·
âœ… `item_accessories` - é¥°å“
âœ… `item_consumables` - æ¶ˆè€—å“
âœ… `item_materials` - ææ–™
âœ… `item_quest` - ä»»åŠ¡ç‰©å“

### æŠ€èƒ½ç›¸å…³è¡¨ï¼ˆ8ä¸ªï¼‰
âœ… `skill_learns` - æŠ€èƒ½å­¦ä¹ 
âœ… `skill_charge` - æŠ€èƒ½å……èƒ½
âœ… `skill_conflictcounts` - æŠ€èƒ½å†²çªè®¡æ•°
âœ… `skill_damageattenuation` - ä¼¤å®³è¡°å‡
âœ… `skill_prohibit` - æŠ€èƒ½ç¦ç”¨
âœ… `skill_qualification` - æŠ€èƒ½èµ„æ ¼
âœ… `skill_randomdamage` - éšæœºä¼¤å®³
âœ… `skill_signetdata` - ç¬¦æ–‡æ•°æ®

---

## ä½¿ç”¨æ–¹å¼

### åŸºæœ¬ç”¨æ³•

```java
ServerComplianceFilter filter = new ServerComplianceFilter();

// å•æ¡æ•°æ®è¿‡æ»¤
FilterResult result = filter.filterForExport("items", itemData);
Map<String, Object> cleanData = result.getFilteredData();

// æ‰¹é‡æ•°æ®è¿‡æ»¤
List<FilterResult> results = filter.filterBatch("items", itemList);

// ç”ŸæˆæŠ¥å‘Š
String report = filter.generateBatchFilterStatistics("items", results);
logger.info(report);
```

### é›†æˆåˆ°DbToXmlGenerator

```java
public void generateXml(String tableName, String outputPath) {
    // 1. è¯»å–æ•°æ®
    List<Map<String, Object>> dataList = queryFromDatabase(tableName);

    // 2. åº”ç”¨è¿‡æ»¤
    ServerComplianceFilter filter = new ServerComplianceFilter();
    List<FilterResult> results = filter.filterBatch(tableName, dataList);

    // 3. ä½¿ç”¨è¿‡æ»¤åçš„æ•°æ®
    List<Map<String, Object>> cleanData = results.stream()
        .map(FilterResult::getFilteredData)
        .collect(Collectors.toList());

    // 4. ç”ŸæˆXML
    writeToXml(cleanData, outputPath);
}
```

---

## æ–‡æ¡£å¯¼èˆª

### ğŸ“Š æ•°æ®åˆ†æ
- **[è¯¦ç»†åˆ†ææŠ¥å‘Š](SERVER_COMPLIANCE_ANALYSIS.md)** - æ·±åº¦æ—¥å¿—åˆ†æã€é”™è¯¯æ¨¡å¼ã€è§„åˆ™è®¾è®¡ï¼ˆ60é¡µå®Œæ•´æŠ¥å‘Šï¼‰
- **[é”™è¯¯ç»Ÿè®¡æ•°æ®](error_statistics.csv)** - 22,891æ¡é”™è¯¯è®°å½•çš„ç»“æ„åŒ–æ•°æ®

### ğŸ“˜ ä½¿ç”¨æ•™ç¨‹
- **[ä½¿ç”¨æŒ‡å—](USAGE_GUIDE.md)** - å®Œæ•´çš„ä½¿ç”¨æ•™ç¨‹ï¼ŒåŒ…å«ç¤ºä¾‹ä»£ç å’Œæ•…éšœæ’æŸ¥
- **[å¿«é€Ÿå‚è€ƒ](QUICK_REFERENCE.md)** - ä¸€é¡µçº¸é€ŸæŸ¥æ‰‹å†Œï¼Œå¸¸ç”¨ä»£ç ç‰‡æ®µ

### ğŸ’» æºä»£ç 
- **FieldConstraint.java** - å­—æ®µçº¦æŸå®šä¹‰å’ŒéªŒè¯é€»è¾‘
- **FileValidationRule.java** - æ–‡ä»¶çº§è§„åˆ™æ¨¡å‹
- **XmlFileValidationRules.java** - è§„åˆ™æ³¨å†Œè¡¨ï¼ˆ18ä¸ªè¡¨ï¼Œ138æ¡è§„åˆ™ï¼‰
- **ServerComplianceFilter.java** - è§„åˆ™å¼•æ“æ ¸å¿ƒå®ç°

---

## è®¾è®¡åŸåˆ™

### å®½è¿›ä¸¥å‡º
- âœ… **å¯¼å…¥ï¼ˆDBâ†’Toolï¼‰**ï¼šå®½æ¾ï¼Œä¿ç•™æ‰€æœ‰å­—æ®µï¼ˆåŒ…æ‹¬ä¸å…¼å®¹å­—æ®µï¼‰
- âœ… **å¯¼å‡ºï¼ˆToolâ†’Serverï¼‰**ï¼šä¸¥æ ¼ï¼Œåº”ç”¨æœåŠ¡å™¨éªŒè¯è§„åˆ™ï¼Œè‡ªåŠ¨è¿‡æ»¤

### é€æ˜å¯å®¡è®¡
- âœ… æ¯æ¬¡è¿‡æ»¤éƒ½ç”Ÿæˆè¯¦ç»†æ—¥å¿—
- âœ… è®°å½•ç§»é™¤çš„å­—æ®µã€ä¿®æ­£çš„å€¼ã€è­¦å‘Šä¿¡æ¯
- âœ… æ”¯æŒæ‰¹é‡ç»Ÿè®¡æŠ¥å‘Š

### å¯ç»´æŠ¤æ€§
- âœ… è§„åˆ™é›†ä¸­ç®¡ç†ï¼ˆXmlFileValidationRulesï¼‰
- âœ… æ”¯æŒå¤–éƒ¨åŒ–é…ç½®ï¼ˆYAMLï¼‰
- âœ… æ˜“äºæ·»åŠ æ–°è§„åˆ™

---

## ç¤ºä¾‹è¾“å‡º

### è¿‡æ»¤æŠ¥å‘Š

```
================================================================================
è¡¨ items çš„å¯¼å‡ºè¿‡æ»¤æŠ¥å‘Š
================================================================================

ç§»é™¤çš„é»‘åå•å­—æ®µ (3ä¸ª):
  - __order_index
  - drop_prob_6
  - erect

ä¿®æ­£çš„å­—æ®µå€¼ (1ä¸ª):
  - stack: 10000 -> 9999 (è¶…å‡ºèŒƒå›´)

è­¦å‘Š (0ä¸ª):

================================================================================
```

### æ‰¹é‡ç»Ÿè®¡

```
================================================================================
è¡¨ items çš„æ‰¹é‡å¯¼å‡ºè¿‡æ»¤ç»Ÿè®¡
================================================================================
æ€»è®°å½•æ•°: 22162
ä¿®æ”¹çš„è®°å½•: 22162 (100.00%)
æœ‰è­¦å‘Šçš„è®°å½•: 0 (0.00%)

ç§»é™¤å­—æ®µç»Ÿè®¡:
  - __order_index: 22162æ¬¡
  - drop_prob_6: 6æ¬¡
  - drop_prob_7: 6æ¬¡
  - erect: 60æ¬¡
================================================================================
```

---

## æŠ€æœ¯æ ˆ

- **Java 25** - ä½¿ç”¨æœ€æ–°ç‰¹æ€§
- **Spring Boot** - ä¾èµ–æ³¨å…¥å’Œé…ç½®ç®¡ç†
- **SLF4j + Logback** - æ—¥å¿—è®°å½•
- **SnakeYAML** - é…ç½®æ–‡ä»¶è§£æï¼ˆå¯é€‰ï¼‰

---

## æ€§èƒ½ä¼˜åŒ–

### å¹¶è¡Œå¤„ç†
```java
List<FilterResult> results = dataList.parallelStream()
    .map(data -> filter.filterForExport(tableName, data))
    .collect(Collectors.toList());
```

### SQLé¢„è¿‡æ»¤
```java
// åœ¨æ•°æ®åº“æŸ¥è¯¢æ—¶å°±æ’é™¤é»‘åå•å­—æ®µ
Set<String> allowedFields = getAllowedFields(tableName);
String sql = String.format("SELECT %s FROM %s",
    String.join(", ", allowedFields), tableName);
```

---

## æœªæ¥æ‰©å±•

### 1. æ™ºèƒ½è§„åˆ™æ¨æ–­
åŸºäºæ–°æ—¥å¿—è‡ªåŠ¨æ›´æ–°è§„åˆ™ï¼š
```java
AutoRuleInferrer.inferBlacklistFields(newServerLog);
```

### 2. ç‰ˆæœ¬åŒ–è§„åˆ™
æ”¯æŒä¸åŒæœåŠ¡å™¨ç‰ˆæœ¬ï¼š
```yaml
rulesets:
  - version: "5.8"
  - version: "6.0"
```

### 3. å¯è§†åŒ–è§„åˆ™ç¼–è¾‘å™¨
JavaFX GUIç•Œé¢ç®¡ç†è§„åˆ™

---

## è´¡çŒ®è€…

**Claude Code** - æ—¥å¿—åˆ†æã€è§„åˆ™è®¾è®¡ã€ç³»ç»Ÿå®ç°

---

## è®¸å¯è¯

æœ¬é¡¹ç›®æ˜¯ dbxmlTool çš„ä¸€éƒ¨åˆ†

---

## æ›´æ–°æ—¥å¿—

### v1.0 (2025-12-29)
- âœ… å®Œæˆ206,352è¡Œæ—¥å¿—çš„æ·±åº¦åˆ†æ
- âœ… æ„å»º18ä¸ªè¡¨çš„138æ¡éªŒè¯è§„åˆ™
- âœ… å®ç°å®Œæ•´çš„è§„åˆ™å¼•æ“
- âœ… ç¼–å†™è¯¦ç»†çš„æ–‡æ¡£å’Œä½¿ç”¨æŒ‡å—

---

**æœ€åæ›´æ–°**: 2025-12-29
**ç‰ˆæœ¬**: 1.0
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª
